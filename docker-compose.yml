version: "3.3"

x-base_service: &base_service
  profiles: ["nvidia", "amd"]
  tty: true
  stdin_open: true
  env_file: .env
  ipc: host

x-base_service_nvidia: &base_service_nvidia
  <<: *base_service
  stop_signal: SIGKILL
  profiles: ["nvidia"]
  deploy:
    resources:
      reservations:
        devices:
          - driver: nvidia
            device_ids: ["0"]
            capabilities: [gpu]

x-base_service_amd: &base_service_amd
  <<: *base_service
  stop_signal: SIGINT
  profiles: ["amd"]
  group_add:
    - video
  devices:
    - "/dev/dri"
    - "/dev/kfd"

services:
  ui:
    <<: *base_service
    build:
      dockerfile: Dockerfile
      context: ./typescript
    ports:
      - "${UI_HOST_PORT}:${UI_CONT_PORT}"

  vllm:
    <<: *base_service_nvidia
    build:
      dockerfile: Dockerfile_NVIDIA
      context: ./vllm
    ports:
      - "${VLLM_HOST_PORT}:${VLLM_CONT_PORT}"

  omnipedia:
    <<: *base_service_nvidia
    build:
      dockerfile: Dockerfile_NVIDIA
      context: ./rust
    ports:
      - "${OMNIPEDIA_HOST_PORT}:${OMNIPEDIA_CONT_PORT}"
    volumes:
      - ./rust/db:/db

  embeddings:
    <<: *base_service_nvidia
    build:
      dockerfile: Dockerfile_NVIDIA
      context: ./embeddings_service
    ports:
      - "${EMBED_HOST_PORT}:${EMBED_CONT_PORT}"

  vllm-amd:
    <<: *base_service_amd
    build:
      dockerfile: Dockerfile_AMD
      context: ./vllm
    ports:
      - "${VLLM_HOST_PORT}:${VLLM_CONT_PORT}"

  omnipedia-amd:
    <<: *base_service_amd
    build:
      dockerfile: Dockerfile_AMD
      context: ./rust
    ports:
      - "${OMNIPEDIA_HOST_PORT}:${OMNIPEDIA_CONT_PORT}"
    volumes:
      - ./rust/db:/db

  embeddings-amd:
    <<: *base_service_amd
    build:
      dockerfile: Dockerfile_AMD
      context: ./embeddings_service
    ports:
      - "${EMBED_HOST_PORT}:${EMBED_CONT_PORT}"
