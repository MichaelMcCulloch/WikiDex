version: "3.3"

x-base_service: &base_service
  stop_signal: SIGTERM
  restart: always
  tty: true
  stdin_open: true
  env_file: .env
  ipc: host

x-base_service_nvidia: &base_service_nvidia
  <<: *base_service
  profiles: ["service", "server"]
  deploy:
    resources:
      reservations:
        devices:
          - driver: nvidia
            device_ids: ["0"]
            capabilities: [gpu]

# x-base_service_amd: &base_service_amd
#   <<: *base_service
#   profiles: ["amd"]
#   group_add:
#     - video
#   devices:
#     - "/dev/dri"
#     - "/dev/kfd"

x-base_service_ui: &base_ui
  ports:
    - "${UI_HOST_PORT}:${UI_CONT_PORT}"

x-base_service_omnipedia: &base_omnipedia
  ports:
    - "${OMNIPEDIA_HOST_PORT}:${OMNIPEDIA_CONT_PORT}"
  volumes:
    - ./rust/db:/db
    - ./rust/prompt:/prompt
x-base_service_redis: &base_redis
  image: redis:latest
  ports:
    - "6379:6379"
  volumes:
    - ./redis/data:/root/redis
    - ./redis/redis.conf:/usr/local/etc/redis/redis.conf
  environment:
    - REDIS_PASSWORD=redis
    - REDIS_PORT=6379
    - REDIS_DATABASES=16

services:
  omnipedia:
    <<:
      - *base_service
      - *base_omnipedia
    build:
      dockerfile: Dockerfile
      context: ./rust

  ui:
    <<:
      - *base_service
      - *base_ui
    build:
      dockerfile: Dockerfile
      context: ./typescript
